---
bookCollapseSection: false
---

# Anatomy of a Vulnerability

In this section we will go over some vulnerabilities in the simple notes application, as well as how they are exploited, and how to resolve/remediate them.
Some vulnerabilities we will go over include:

- SQL Injection

## SQL Injection

This guide will show how SQL injections work, and explain how vulnerabilities in your application can be exploited and cause harm to your organization.

Now let's go ahead and perform a SQL injection on our application. We will:

1. Obtain `secret` data we shouldn't have access to
2. Delete `secret` data we shouldn't be able to delete

### Exposing Secret data

In this example, I will show how to obtain data we shouldn't have access to.
The [Notes API](../api_guide/) contains a **get** API path, which is susceptible to SQL injection. We will exploit in a vulnerability in the **get** API path in order to obtain **secret** notes created by an admin.

{{< hint warning >}}
**Note:**
By design the **GET** API path should not list **secret** notes
{{< /hint >}}

**1. Let's start by creating a few notes via the UI**

This can be done by just going to your application, adding a note, and pressing submit. Let's go ahead and  add the following:

* cat
* dog
* frog
* hog

{{< hint info >}}
**Note:**
You can also add notes via the API. See the [API Guide]((../api_guide/))
for more info.
{{< /hint >}}

**2. Now let's login as an admin, and create some more notes**

In order to login as an admin, simply press the **admin** button in the UI.
A basic-auth prompt screen will come up, where you can use the hardcoded [username/password](https://gitlab.com/tech-marketing/devsecops/initech/simple-notes/-/blob/main/notes/__init__.py#L25)

In this view, any notes we add will be **secret** and can only be seen by an
admin. Let's go ahead and add a couple:

* meow
* bark
* ribbit
* grunt

{{< hint warning >}}
**Note:**
Any secrets created as an admin will be tagged as secret and should
not be visible in a non-admin view.
{{< /hint >}}

{{< hint info >}}
**Note:**
You can also add notes via the Admin API. See the [Admin API Guide]((../api_guide/))
at the bottom of the page for more info.
{{< /hint >}}

**3. Get notes via API**

Now that the notes have been created, lets try to view them with the API.

```bash
# Get all notes, notice "secret" notes aren't there
$ curl http://{LOAD_BALANCER_IP}/{APPLICATION_PATH}/api
{"Note":"[(1, 'cat'), (2, 'dog'), (3, 'frog'), (4, 'hog')]"}

# Get note by id
$ curl http://{LOAD_BALANCER_IP}/{APPLICATION_PATH}/api\?id\=1
{"Note":"[(1, 'cat')]"}

# Try and get a secret note, notice empty return
$ curl http://{LOAD_BALANCER_IP}/{APPLICATION_PATH}/api\?id\=5
{"Note":"[]"}

# Try and get a secret note as an admin, notice it does display it
$ curl -u admin:yeet http://{LOAD_BALANCER_IP}/{APPLICATION_PATH}/api/admin\?id\=5
{"Note":"[(5, 'YEET', '73.139.128.92', 'c-73-139-128-92.hsd1.fl.comcast.net', 1)]"}
```

**4. Get Secret notes via SQL injection**

Now let's try to add additional criteria to the **id** in order
to try and expose secret information:

```bash
# pass url encoded string '1 or 1=1' which is `1%20or%201%3D1` as the id
$ curl http://34.27.132.210/notes-staging/api\?id\=1%20or%201%3D1

{"Note":"[(1, 'cat'), (2, 'dog'), (3, 'frog'), (4, 'hog'), (5, 'meow'), (6, 'bark'), (7, 'ribbit'), (8, 'grunt')]"}
```

The above shows a SQL injection performed to gain additional data by passing
`1 or 1=1` which creates the following query:

```sql
SELECT id, data FROM notes WHERE secret IS FALSE AND id = 1 OR 1=1;
```

The `1=1` evaluates to true, which means completes to `id = 1 OR TRUE`
which will show all notes as well as the ip-address used to create it
and the hostname, which should only be available to admins.

{{< hint info >}}
**Note:**
I used [https://www.urlencoder.org/](https://www.urlencoder.org/) in order
to encode the `1 or 1=1` parameter.
{{< /hint >}}

This is how a hacker üè¥‚Äç‚ò†Ô∏è can expose additional data in a malicious way. Usually
this will be done in an automated fashion trying all kinds of SQL queries.

### Deleting **Secret** data

Now that we can see all the data (even what's secret) within the database, we
can try to manipulate the **delete** functionality in order to delete what we don't
have access to.

#### Via UI

Going back to the basic application view (non-admin), we can try to input data to delete secret notes we shouldn't be able to delete.

**1. Delete non-secret note**

Input `1` in the delete field and press the submit button.
You can see that the note has been successfully been deleted.

**2. Fail to delete note secret note**

Input `5` in the delete field and press the submit button.
You can see that the note did not delete. This is because we are not
able to delete a **secret** note as a non-admin.

3. Delete **secret** note via SQL injection

Now let's try to add additional criteria to the delete field in order
to try and delete a **secret** note:

Input `2 OR (id = 5)` to the delete field and press the submit button.
This SQL injection will delete both notes with `id=2` and `id=5`.

4. Login as admin and check notes

Note that the note with id `5`was deleted. This is because submitting
`2 OR (id = 5)` completes the following query:

```sql
DELETE FROM notes WHERE (SECRET is FALSE AND id = 2) OR (id = 5);
```

which will delete both notes.

{{< hint info >}}
**Note:**
`2 OR (id = 5)` can also be passed into the API encoded as
`2%20OR%20%28id%20%3D%205%29` which will also delete a note
without access.
{{< /hint >}}

### Finding Impacted code

GitLab provides different security scanners which will find these issues.
SAST finds these vulnerabilities and displays the following:

- Title: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')

- Description: Detected possible formatted SQL query. Use parameterized queries instead.

- Line of Code

- Resources showing resolution

- Training

### Resolving SQL injection vulnerabilities

There are a few things we can do to resolve this:

1. Input Validation in Frontend

* Make sure that delete input field can only take integers

2. Input Validation in Backend

* Make sure that the SQL commands being run do not allow extra data

{{< hint info >}}
**Note:**
Be sure to read up on best practices from OWASP.
{{< /hint >}}